package scoin

import scoin._
import utest._

object PuzzleTest extends TestSuite {
  val tests = Tests {
    test(
      "handle puzzle 562a2b7d63f3b7fa8875a4d8af8acda511f30bc01c9a9f3e44514179fcc2d535"
    ) {
      // triggered a bug in OP_PUSHDATA serialization for pushes of 255 bytes
      val tx = Transaction.read(
        "0100000001e74a9be1c1391f243cabd132399d78b78d0ff678f9c80319aabeac93443fdc6200000000fd76014830450221008a518ef81fe953f6ea2452ace508386d88a283cfc9000d901d2a6aa7644a590802203da6d923417b636be48142f6f6f229427fef55d57c4388f67b57dfd265bac251014d2a014cff434e5452505254590300010091c733cb2976bf0cb2a5cd2107fe9e3db387991d400353188ac9be008000000000000000602000002686c13e9d40000000000000003010000216e96bcba32000000000000000180800000a50394ecf90000000000000000c04000000718588312c000000000000000602018bc9a8c924d7fa000000000000000301000002e1e429b3e0000000000000000180800025789672bed70000000000000000c04001e71fb6588bc14000000000000000602018bc9ce2572174c00000000000000030100099ebcc5913b620000000000000001808000304de24762f90000000000000000c04003344c2e6ec8698000000000000000600752103fa3a154104e957ec8ff6f73412ca3ba581a1dc652b550254160ebca5b4fa8215ad0075740087ffffffff0100000000000000000e6a0c20d3f5f0adb0a8770210791b00000000"
      )
      val inputs = List(
        Transaction.read(
          "0100000003fcaa9ca2681b5e22c01dc5e5569f5ed2d0c8604e3be8cfc0a4292e97565dd6ae010000006a47304402200291a7afa6a7d096bc8071ea146ceb4ca6d955f1a37178a861e174a79eb81469022035aa46cd3fcf84ee24504261e7e23cf30334406ce759771c8c13f967732940fb012103fa3a154104e957ec8ff6f73412ca3ba581a1dc652b550254160ebca5b4fa8215ffffffff0325644aee7a5f7743a42cd2d496bf5e1c030dc9ac203319876832b7ea37ba0d010000006b483045022100dc385d366bdef6330ea7207a8b4814648c852dbd10be79f2c356b5c7ccdd1ef602202e3fe418caaca29a2c71e7953efaf224a7c85bcceda0cbdc57e3a9a2d48d719c012103fa3a154104e957ec8ff6f73412ca3ba581a1dc652b550254160ebca5b4fa8215ffffffff9b73b6583f0fdacb379a4952fdb4698596b82b1b6154493b2b76daaf377dddbd010000006b483045022100b599352d292b396d222df12e817cb457de48a77e70ed2b6f5c4818b936da02b40220537de1311664bc0be01637587ffcd859f03afcddd66c80603c39da43037fc9ee012103fa3a154104e957ec8ff6f73412ca3ba581a1dc652b550254160ebca5b4fa8215ffffffff02993e00000000000017a914b8948ef9c89760fbcfe3ab264f1ee6cac1ea7a4887c8220000000000001976a914c6efe1defa350621dc5738ce35b0350330b1470388ac00000000"
        )
      )
      assert(
        Transaction
          .correctlySpends(
            tx,
            inputs,
            ScriptFlags.MANDATORY_SCRIPT_VERIFY_FLAGS
          )
          .isSuccess
      )
    }
    test(
      "handle puzzle f646c600ed438a518aa8263d848b1cb7b1be2620ce51f1358015f95b73a4ef5d"
    ) {
      // triggered a bug in OP_PUSHDATA serialization
      val tx = Transaction.read(
        "01000000018a48180427c3d956e2223035c46cc59fcbf8da62af3e51ae864d7cb560f32fec00000000fd7601483045022100c3168338cba0a12e3e505656d4ad3c4404a75a9a219c14a4b5622a7972a896dc02201f3c0bbecdebd39889244143f033342942d16403e503b86815c581e92fbcc4ef014d2a014cff434e5452505254590300010042276049e5518791be2ffe2c301f5dfe9ef85dd04000000e06e798e88000000000000000a0200000e2dcdb3f580000000000000000501000000052e8e43d20000000000000002808013c6d8878c8d290000000000000000c04000000017263d58800000000000000060200f9265699e7d854000000000000000501000001ee6ce1f9da0000000000000002808000000acffc6ea08000000000000000c040018bdb124010e48000000000000000e020161236905fd3a2400000000000000070100004af12dfd30b4000000000000000280800025789bc91aac0000000000000000c040001504ade4cd6180000000000000006007521036434dc5457858f1f4e056f5c60fb43eb53cc164a689a9fc0a631cf81a42235bbad0075740087ffffffff0100000000000000000e6a0ca0b99063484d6284c804df1700000000"
      )
      val inputs = List(
        Transaction.read(
          "010000000180f6c0cf2105ff105c0443354853ac8fb05631a13d67a16c053a834407beb012010000006b483045022100ea67f6784191048eaabf9f18f8ef402199ebf9abb22a65d1b0b64d241068e2f0022020b5f5974cee588f87e63660590af1c89203b70b6b95ae5ca8572ba9232d83830121036434dc5457858f1f4e056f5c60fb43eb53cc164a689a9fc0a631cf81a42235bbffffffff02993e00000000000017a9145b66694be04ca76d4c7054bc0fdb8c8895601c3a8704043b00000000001976a914dce03a710da4d2edaee45c444fbdaa06e9f2a19488ac00000000"
        )
      )
      assert(
        Transaction
          .correctlySpends(
            tx,
            inputs,
            ScriptFlags.MANDATORY_SCRIPT_VERIFY_FLAGS
          )
          .isSuccess
      )
    }
  }
}
